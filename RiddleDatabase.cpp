// 檔案: RiddleDatabase.cpp
#include "pch.h"
#include "RiddleDatabase.h"
#include "Globals.h"
#include <unordered_map>
#include <windows.h>
#include <cstdio>
#include <algorithm>
#include <stdexcept>

// 【修正】將命名空間定義移到全域，而不是函式內部
namespace Addr_Riddle {
    constexpr DWORD RiddleStringOffset = 0x16982D;
    constexpr DWORD RiddleGuardOffset = 0x169A4D;
    constexpr DWORD RiddleOption1Offset = 0x169A52;
    constexpr DWORD RiddleOption2Offset = 0x169B62;
    constexpr DWORD RiddleOption3Offset = 0x169C72;
    constexpr DWORD RiddleGuardValue = 0x44A1B0A2;
}

// 函式的具體實作
static std::wstring GetRiddleAnswer(const std::wstring& riddleText) {
    static const std::unordered_map<std::wstring, std::wstring> riddleAnswerMap = {
        //填空
        {L" 大的海星和水分多的梨子能做成何種料理？", L"$海星梨"},
        {L" 曬乾的海星跟曬乾的炭可以做成哪種料理？", L"$海星火焰"},
        {L"「充滿原始風味的粽子」之稱的是哪一種料理", L"$原始粽子"},
        {L"「逃走呼拔拔」獵人名人的名字是？", L"$吉薩拉奇"},
        {L"卡比特、凱比、昆伊、凱比特的各別風屬性合", L"$26"},
        {L"卡魯它那的村子的東77南93有誰在那呢？", L"$釣竿專家"},
        {L"卡魯它那的長毛象客運的介紹人的名字是？", L"$阿民"},
        {L"用多多的美味的水、毛蟹、大王花枝、塔姆塔", L"$美食湯"},
        {L"用最棒的食材製作的納豆名稱為？", L"$特選納豆"},
        {L"用新鮮的花枝、美麗的鹽、品質優良的炭能做", L"$新鮮的烤花枝"},
        {L"全身發紅、看起來又軟弱，還會過來用大舌頭", L"$貝洛寶利"},
        {L"向我們推銷茶的村長是哪個村莊的？（寫村名", L"$柯爾克"},
        {L"回答卡魯它那的村長所站位置的座標。（例→", L"$東17:南20"},
        {L"回答料理「豪華船生魚片」的說明文。", L"$究極生魚片"},
        {L"在加加的村子的防具屋賣594S的防具名稱正確", L"$提歐Lv1鎧2"},
        {L"在加加的便利商店內，圓的坐墊有幾張？（請", L"$32"},
        {L"在沙姆島（地上），除了鳥的恐龍之外還有什", L"$布拉奇多斯"},
        {L"在畫面上可以選擇出身地的村莊是瑪麗娜絲、", L"$卡魯它那"},
        {L"在瑪麗娜絲賣的高級瑪麗娜絲蝦要多少石頭？", L"$150"},
        {L"在薩伊那斯的橋上阻礙通行的是誰?", L"$壞心眼的願藏"},
        {L"多多的便利武器店所賣商品的總值是？（只限", L"$34170"},
        {L"到卡魯它那上學的小孩子有幾個人？（半形數", L"$5"},
        {L"長毛象客運加加分店的介紹人的名字是？", L"$卡魯那"},
        {L"阿布的洞窟前的儲存點要用布伊和什麼寵物的", L"$火雞"},
        {L"柯奧的防具店最高賣價的東西和霍特爾的武器", L"$10850"},
        {L"柯爾克村寵物店裡有的寵物是呼拔拔和貝洛恩", L"$小特洛昆"},
        {L"柯爾克的青年買了弓和什麼武器之後卻在煩惱", L"$迴力標"},
        {L"美容師給玩家哪一種參數值的改變呢？", L"$魅力"},
        {L"恐龍接龍「？？？」裡面恐龍的名字是？　「", L"$卡比特"},
        {L"恐龍博士的助手的名字是？", L"$吉魯"},
        {L"格爾頓跟格爾格在前面和後面，那麼奇拉頓在", L"$上"},
        {L"能使玩家在被攻擊時將攻擊反射回去一次的是", L"$鏡的精靈"},
        {L"盜賊的洞窟地下3樓的人的名字是？", L"$鐵壁的小守"},
        {L"瑪麗娜絲的村莊的女子提到的鴨子是？", L"$加亞鴨"},
        {L"說明文為「跟料理鐵人一樣有所堅持的關東煮", L"$鐵人關東煮"},
        {L"請正確回答能夠改變戰鬥畫面中全體團員（含", L"$調和的精靈"},
        {L"請回答卡坦的留言板的座標？（例→東0:南0 ", L"$東78:南97"},
        {L"請回答用新鮮的花枝、美麗的鹽、品質優良的", L"$拿很新鮮的花枝來烤"},
        {L"請回答料理「獨門秘方牛肉燉煮」的說明文是", L"$燉很久的牛肉燉煮"},
        {L"請寫出可以一次回復全體團員耐久力的精靈咒", L"$恩惠的精靈"},
        {L"薩姆吉爾村長家的料理人名字是？", L"$鮑爾"},
        {L"寵物接龍「？？？」裡的寵物的名字是？「貝", L"$恩摩摩"},
        //選擇
        {L" 「蘋果醬汁牛排」料理的說明文為以下何者?", L" 都是蘋果的牛排"},
        {L" 清澈的鱗是鱗的成分幾呢。", L"鱗的成分4"},
        {L"「○○○○的近藏」那麼○裡面應該是？", L"山賊志願"},
        {L"「壞心眼的願藏」是哪一手拿著武器的呢？", L"右手"},
        {L"一遇到跑過來的長毛象公車、人物會變成怎樣", L"不會怎樣"},
        {L"下列那一種料理是不存在的？", L"新鮮好吃的牛肉"},
        {L"下列哪一個是在生日蛋糕的材料中是沒有的？", L"橡樹實"},
        {L"下列哪個無法回復25氣力？", L"熱肉湯"},
        {L"下列哪種料理沒有回復氣力22的效果?", L"石烤地瓜"},
        {L"下面3個精靈之中屬於非回復系咒術的是哪個", L"守護的精靈"},
        {L"下面哪一個沒有「捕獲率1UP 」的效果？", L"橘子糖"},
        {L"下面哪種料理內有青蛙跟海藻？", L"青蛙手卷"},
        {L"小斧頭跟小棍棒，哪一個比較貴呢？", L"小斧頭"},
        {L"日美子和彌生誰在瑪麗娜絲？", L"彌生"},
        {L"以下有火屬性的寵物是？", L"布伊比"},
        {L"以下有地屬性的寵物是哪一個？", L"克雷爾"},
        {L"以下沒有「酒醉4回合前後」效果的料理是？", L"甜的水果酒"},
        {L"以下那些沒有「氣2回復」效果的是？", L"生包心菜"},
        {L"以下那些沒有「氣5回復」效果的是？", L"綠色沙拉"},
        {L"以下屬性沒有『地10』的是哪一個？", L"綠龜"},
        {L"加工用的道具中，最便宜的是東西是什麼石？", L"石1"},
        {L"加加的便利商店裡，料理老師並沒有告訴我們", L"料理的說明"},
        {L"加加的道具屋有賣什麼？", L"阿昆尼斯Lv3鳴子"},
        {L"加加的蔬菜店有賣以下哪種東西？", L"薩姆吉爾產的柿子"},
        {L"加加的儲存點拿什麼肉來就會讓我們紀錄呢？", L"烏寶寶的肉"},
        {L"加魯卡巡迴全島活動（JOT）的A路線的第9個", L"烏魯力"},
        {L"加魯卡島最南邊的村莊的名稱是？", L"奇喀喀"},
        {L"卡坦的儲存點是拿什麼肉去才會給我們記錄呢", L"特洛昆"},
        {L"卡魯它那牧場屋內的寵物全部有幾隻？", L"10"},
        {L"卡魯它那的情報員現在幾歲請選出正確的答案", L"17"},
        {L"只能幫自己回復的咒術是?", L"治癒的精靈"},
        {L"可以恢復我們魅力的是誰？", L"美容師"},
        {L"石器時代的世界的名稱是?", L"尼斯"},
        {L"石器時代新手報到包的定價是？", L"250台幣"},
        {L"石龜屬性是？", L"地９　風１"},
        {L"吃回復氣力的料理的時候玩家角色的反應是？", L"點頭"},
        {L"在公式比武中規定的50∼59的等級是？", L"貝魯卡級"},
        {L"在加魯卡島最北邊的村莊名稱是?", L"塔姆塔姆"},
        {L"在卡魯它那村裡的情報員10年前地震的時候是", L"7歲"},
        {L"在卡魯它那牧場利用恐龍的什麼跟什麼可以生", L"皮跟骨"},
        {L"在卡魯它那的附近打工抓寵物中LV20以上30未", L"多利諾布斯"},
        {L"在卡魯它那的素材店（石頭、木）有在賣『骨", L"26STONE"},
        {L"在柯爾克村的道具店中，下列那一種東西最便", L"紅色大首飾"},
        {L"在達那村的道具店中，下列哪一種東西最昂貴", L"黑骨首飾"},
        {L"在瑪麗娜絲的醫院幫我們的回復的護士，手上", L"注射器"},
        {L"在薩姆吉爾村出生的人所拿的原生寵物是什麼", L"烏力烏力"},
        {L"在薩姆吉爾裡大石像的模特兒是誰？", L"薩姆吉爾"},
        {L"在醫院，要幫寵物回復要花多少石頭？", L"不用錢"},
        {L"成人的儀式結束之後能得到什麼呢？", L"儀之兜"},
        {L"肚子是橘色的鯊魚系寵物是？", L"加克拉"},
        {L"那一個不是霍特爾產的？", L"蘿蔔"},
        {L"到卡坦村看醫生的患者初診通常都是患什麼病", L"中暑"},
        {L"玩家人物中頭髮是黑色的有多少人?", L"4"},
        {L"玩家互相比試應要叫做什麼？", L"決鬥"},
        {L"玩家在石器裡無法做的動作是？", L"睡覺"},
        {L"玩家角色或是寵物氣絕時在頭上環繞的星星有", L"3個"},
        {L"玩家身上最多可以帶多少石頭幣？", L"1000000"},
        {L"近藏的寵物的名字是？", L"小卡"},
        {L"長毛象公車出發時的鳴叫聲是？", L"叭叭叭∼∼∼"},
        {L"長毛象公車在公車站停留多久的時間呢？", L"3分"},
        {L"長毛象公車的大象名字叫什麼？", L"瑪恩摩"},
        {L"阿布的獨棟房屋裡共有多少坐墊呢？", L"10枚"},
        {L"怎樣才能坐長毛象公車呢?", L"加入團隊"},
        {L"查罕三兄弟中最小的弟弟名字是哪一個？", L"查罕魯德"},
        {L"柯爾克的石屋主人是幾歲開始作投擲石的呢？", L"13"},
        {L"紅玉的手環的數值是以下的哪一個？", L"攻+2防+2敏-2魅+1"},
        {L"要做「危險的生魚片」的材料是下咧哪一個？", L"卷貝"},
        {L"要做成漁村風烤貝殼以下哪一個是不需要的？", L"卡魯它那產的鹽"},
        {L"哥亞山的烏力斯凱是把信交給誰？", L"烏力美"},
        {L"捉迷藏少年裡奧所持有的願藏人偶是朝向左右", L"右"},
        {L"料理「肉粽」的道具說明是以下的哪一個？", L" 包肉的粽子"},
        {L"料理「海星的鹽味串燒」的效果是以下哪一個", L"5回合左右酒醉"},
        {L"料理「烤焦的蝦子串燒」的效果是以下哪一個", L"石化3回合前後 "},
        {L"料理「跳躍青蛙」是由下列哪種材料所製造出", L"青蛙+油"},
        {L"料理「螃蟹味噌湯」的效果是以下哪個？", L"氣70回復(1體) "},
        {L"氣力回復40的氣力回復藥瓶子是什麼顏色的呢", L"黃色"},
        {L"烏力斯坦的顏色是什麼色跟什麼色？", L"黑色跟白色"},
        {L"烏力斯坦最初所擁有的技能是下列哪一個？", L"攻擊"},
        {L"烏西摩尼葉的說明中，「解毒的？？？植物」", L"熱帶性"},
        {L"能跟烏力斯凱說話的道具是？", L"不可思議的貝殼"},
        {L"能幫團隊全員回復的咒術是?", L"恩惠的精靈"},
        {L"馬倫所飼養的寵物的名字是？", L"加特力奴"},
        {L"做三明治的時候那一種東西是絕對會被放進去", L"橡樹果"},
        {L"基本上來說，雖然攻擊力上升，但是防禦或敏", L"斧頭"},
        {L"組成團隊最大人數是多少人？", L"5人"},
        {L"聊天室中的大廳叫什麼名稱?", L"長毛象大廳"},
        {L"這個世上用錢做成的地方是哪裡？", L"吉魯島"},
        {L"這個世界錢的單位是?", L"石頭"},
        {L"這個遊戲的英文名稱是？", L"STONEAGE"},
        {L"通過海底通道需要什麼?", L"通行證"},
        {L"凱比特的身體是什麼顏色？", L"黃色"},
        {L"等級由1變到2要多少經驗值?", L"２"},
        {L"塔姆塔姆村裡的「情報員」是怎樣的人？", L"老伯"},
        {L"塔姆塔姆的醫生2年前曾經在哪個醫院呢？", L"薩姆吉爾"},
        {L"經營長毛象公車的是？", L"長毛象客運"},
        {L"道具『仙尼亞的花』的正確說明是哪一個？", L"在薩姆吉爾花圃上摘的花"},
        {L"對著奇喀喀村長家大門時，站左側的警備員是", L"弟弟"},
        {L"瑪麗娜絲村莊中和青年在一起的烏力烏力的叫", L"烏力次郎"},
        {L"說明文為「裡面有青蛙…」的料理是下面哪一", L"青蛙手卷"},
        {L"摩浦葉是在哪裡生長的植物呢？", L"平原"},
        {L"請選出下列名稱錯誤的東西。", L"綠玉首飾"},
        {L"戰鬥中用弓箭給予傷害（或是接受）之後，打", L"回合結束之前還會存在"},
        {L"薩姆吉爾的學校的老師手裡拿著什麼？", L"骨頭"},
        {L"寵物的技巧之中保護玩家的技能叫做什麼？", L"忠犬"},
        {L"願藏的寵物的名字是?", L"呼拔吉"},
    };
    auto it = riddleAnswerMap.find(riddleText);
    if (it != riddleAnswerMap.end()) {
        return it->second;
    }
    return L"";
}
// 【修改】新的公開函式 QA()，採用了您最新的邏輯
std::wstring QA() {
    if (!Sa_PID || !Sa_base) {
        return L"CANCEL"; // 目標未綁定
    }
    HANDLE hProcess = OpenProcess(PROCESS_VM_READ, FALSE, Sa_PID);
    if (!hProcess) {
        return L"CANCEL"; // 開啟行程失敗
    }
    std::wstring finalOutput = L"";
    wchar_t unicodeBuffer[256] = { 0 };
    char big5Buffer[256] = { 0 };
    LPCVOID dynamicRiddleAddr = (LPCVOID)((BYTE*)Sa_base + Addr_Riddle::RiddleStringOffset);
    // 只讀取一次，不再重試
    if (ReadProcessMemory(hProcess, dynamicRiddleAddr, big5Buffer, sizeof(big5Buffer) - 1, NULL)) {
        MultiByteToWideChar(950, 0, big5Buffer, -1, unicodeBuffer, 256);
        std::wstring correctAnswer = GetRiddleAnswer(unicodeBuffer);
        if (!correctAnswer.empty()) {
            // 如果找到了標準答案，繼續執行選項判斷
            finalOutput = correctAnswer;
            DWORD guardValue = 0;
            LPCVOID dynamicGuardAddr = (LPCVOID)((BYTE*)Sa_base + Addr_Riddle::RiddleGuardOffset);
            ReadProcessMemory(hProcess, dynamicGuardAddr, &guardValue, sizeof(guardValue), NULL);
            if (guardValue == Addr_Riddle::RiddleGuardValue) {
                auto checkOption = [&](DWORD optionOffset) -> bool {
                    char optBig5[256] = { 0 };
                    wchar_t optUnicode[256] = { 0 };
                    LPCVOID dynamicOptionAddr = (LPCVOID)((BYTE*)Sa_base + optionOffset);
                    if (ReadProcessMemory(hProcess, dynamicOptionAddr, optBig5, sizeof(optBig5) - 1, NULL)) {
                        MultiByteToWideChar(950, 0, optBig5, -1, optUnicode, 256);
                        return (correctAnswer == optUnicode);
                    }
                    return false;
                    };
                if (checkOption(Addr_Riddle::RiddleOption1Offset)) finalOutput = L"1";
                else if (checkOption(Addr_Riddle::RiddleOption2Offset)) finalOutput = L"2";
                else if (checkOption(Addr_Riddle::RiddleOption3Offset)) finalOutput = L"3";
            }
        }
    }
    CloseHandle(hProcess);
    // 如果 finalOutput 仍然是空的 (讀取失敗或題庫無匹配)，則返回 CANCEL
    if (finalOutput.empty()) {
        return L"CANCEL";
    }
    return finalOutput;
}