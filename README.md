# Assa 8.05b5 Hook 增強專案 (重構版)

## 1. 專案概述 (Project Overview)

本專案是一個為 `Assa8.0B5.exe` 設計的 C++ DLL Hook 程式，旨在透過 DLL 注入技術，大幅擴充原程式功能、優化使用者介面(UI)、修復潛在問題，並提供更強大的腳本指令系統。

專案核心技術包含 MinHook 函式庫、手動 JMP Hook、`__declspec(naked)` 內嵌組合語言、Win32 UI 子類化 (Subclassing) 以及 C++ 的現代程式設計實踐。

## 2. 核心功能 (Core Features)

### UI 增強與現代化
- **動態按鈕**：在主介面新增「開始遇敵」、「停止遇敵」、「呼喚野獸」、「冒險公會」、「開啟堆疊」、「開啟掛機」等常用功能按鈕。
- **介面重塑**：重新佈局並隱藏部分舊版 UI，將「快速行走」、「穿牆行走」等功能整合到更合理的面板中。
- **智慧吸附**：新增「視窗吸附」和「子窗吸附」功能，可將主程式或遊戲子視窗自動貼齊主遊戲視窗，方便多視窗操作。
- **在地化修正**：自動將介面中殘留的簡體中文（如「激活石器」、「自動戰斗」）替換為繁體中文。

### 強大的腳本指令系統
- **`Let` 指令擴充**：
    - 新增 `#xpos`, `#ypos` 變數，可讀取遊戲內座標。
    - 新增 `#npcid`, `#winid` 變數，可讀取當前互動的 NPC 和視窗 ID。
    - 新增 `#遊戲時間` 變數。
    - 新增 `#系統毫秒時間戳00`, `#系統秒數時間戳` 變數，提供高精度和循環變化的數值。
    - 支援大小寫不敏感的變數名稱 (例如 `#xpos` 和 `#XPOS` 效果相同)。
- **`Print` 指令擴充**：
    - 新增 `#計時開始`, `#計時停止`, `#時間差00:00:00`，提供一個內建的碼錶計時器。
- **`Assign` 指令 (全新)**：
    - 功能強大的內部變數運算指令。
    - 可對三個內部浮點變數 `ev1`, `ev2`, `ev3` 進行賦值、加、減、乘、除、取餘等運算。
    - 支援**小數**與**負數**運算。
    - 提供 `save` 和 `load` 指令，可將變數值**永久保存**到 `ev_vars.txt` 檔案中，供下次啟動時讀取。
    - **使用範例**：
      ```
      assign ev1,=,100.5
      assign ev2,+,-50
      assign ev3,*,2
      assign save
      assign load
      ```

### 自動化與遊戲修正
- **自動猜謎**：攔截遊戲內的猜謎視窗，自動從內建資料庫比對問題並填入正確答案。
- **自動堆疊**：在特定條件下，可設定為自動執行 `/pile` 指令。
- **坐騎鎖定修復**：修正了原版程式中，特定坐騎會導致無法使用物品的問題。
- **寵物能力檢查**：新增 `#滿血`, `#四圍`, `#尾數` 等多種寵物能力值的進階判斷功能，可供腳本使用。

## 3. 運作原理 (How it Works)

本專案的核心是在 DLL 載入時（`DLL_PROCESS_ATTACH`），透過 `InstallAllHooks()` 函式在目標程式的記憶體中植入一系列的掛鉤 (Hook)。

- **UI 修改 (`UIManager.cpp`)**:
  - 在獨立執行緒中執行，避免鎖定主程式。透過 `EnumChildWindows` 遍歷目標視窗的所有子元件，並使用 `SetParent`, `MoveWindow`, `ShowWindow` 等 API 進行重新佈局。
  - **最關鍵的技術**是「子類化 (Subclassing)」，使用 `SetWindowLongPtrW` 攔截所有自訂按鈕的視窗訊息程序(WndProc)。這使得按鈕點擊事件能被直接捕獲，極大提升了穩定性。

- **功能攔截 (`Hooks.cpp`)**:
  - 透過分析目標程式，找出關鍵功能的記憶體位址偏移 (Offsets)。
  - 主要使用手動寫入 `JMP` 指令的方式，將程式執行流程重導向至我們自訂的函式。
  - 對於複雜的邏輯（如 `Assign` 指令），採用「組合語言呼叫C++」的模式：組合語言負責簡單的流程控制和呼叫，而所有複雜的字串解析、檔案讀寫、數學運算都在易於維護的 C++ 函式中完成。

- **全域狀態管理 (`Globals.h`/`.cpp`)**
  - 所有跨檔案共享的狀態 (如 Assa 和 SA 的程序資訊、`ev` 變數等) 都被集中在 `Globals.h` 中宣告，並在 `Globals.cpp` 中定義。這避免了變數重複宣告和管理混亂的問題。

## 4. 關鍵檔案說明 (Key Files)

- `dllmain.cpp`: DLL 的主進入點，負責初始化 MinHook、安裝所有 Hook，並建立安全的 UI 初始化執行緒。
- `Hooks.cpp`: 專案的核心，定義了所有的記憶體 Hook 點、`__declspec(naked)` 組合語言跳板，以及所有指令擴充功能的 C++ 實現。
- `UIManager.cpp`: 負責所有 UI 相關的操作，包括建立按鈕、重塑版面、處理視窗吸附事件等。
- `Globals.h` / `Globals.cpp`: **(重構核心)** 定義了專案所需的全域變數，如 `ev1`, `ev2`, `ev3` 以及 `g_assaInfo`, `g_saInfo` 等目標資訊結構體。
- `helpers.cpp`: 提供通用的輔助函式，如跨行程讀取遊戲資料、覆寫記憶體中的字串等。
- `RiddleDatabase.cpp`: 一個靜態的問答資料庫，用於實現自動猜謎功能。

## 5. 如何建置 (How to Build)

- **開發環境**: Visual Studio 2022 (或相容版本)
- **目標平台**: x86 (Win32)
- **相依性**: 無外部相依性，專案已內建 MinHook 函式庫的原始碼。
- **步驟**:
    1. 使用 Visual Studio 開啟解決方案檔案 (`.sln`)。
    2. 在上方工具列中，選擇 **Release** 設定。
    3. 在平台下拉選單中，選擇 **x86**。
    4. 點擊功能表中的「建置」->「建置解決方案」。
    5. 編譯成功後，即可在專案的 `Release` 資料夾中找到最終的 `hook.dll` 檔案。