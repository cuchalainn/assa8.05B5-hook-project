# Assa 8.05b5 Hook 增強專案 (高相容穩定版)

## 1. 專案概述

本專案是一個為 `Assa8.0B5.exe` 設計的 C++ DLL Hook 注入程式，旨在透過現代 C++ 和組合語言技術，大幅擴充原程式功能、優化使用者介面 (UI)、修復潛在問題，並提供一個強大、可擴充的腳本指令系統。

經過多次重構，本專案已解決跨作業系統 (Windows 7/10) 的相容性問題，並移除了關鍵功能的硬編碼記憶體位址，實現了與執行檔名稱解耦，使其具備高度的穩定性與移植性。

## 2. 核心功能

### I. 介面 (UI) 增強

* **動態功能按鈕**: 在主介面新增「開始遇敵」、「停止遇敵」、「呼喚野獸」、「冒險公會」、「開啟/取消堆疊」、「開啟/取消掛機」等常用功能按鈕，並透過子類化 (Subclassing) 技術確保高穩定性。
* **介面重塑**: 重新佈局並隱藏部分舊版 UI，將「快速行走」、「穿牆行走」等功能整合至新的面板中，介面更簡潔。
* **智慧視窗吸附**:
    * **主窗吸附**: 可將外掛主視窗自動貼齊遊戲視窗右側。
    * **子窗吸附**: 可將遊戲子視窗（如道具、寵物欄）自動貼齊遊戲視窗右下角，方便多視窗操作。
* **在地化修正**: 自動將介面中殘留的簡體中文（如「激活石器」、「自動戰斗」）替換為繁體中文。

### II. 強大腳本指令系統

* **`Let` 指令擴充**:
    * `#xpos`, `#ypos`: 動態讀取遊戲內人物座標。
    * `#npcid`, `#winid`: 讀取當前互動的 NPC 和視窗 ID。
    * `#遊戲時間`: 讀取遊戲內時間戳。
    * `#系統秒數時間戳`, `#系統毫秒時間戳00`: 提供高精度且循環變化的系統時間數值。
    * `#ev1`, `#ev2`, `#ev3`: 讀取三個全域浮點變數。
    * 所有變數名稱均支援大小寫不敏感。

* **`Print` 指令擴充**:
    * `#計時開始`, `#計時停止`, `#時間差00:00:00`: 提供一個內建的碼錶計時器。

* **`Assign` 指令 (全新)**:
    * 功能強大的內部變數運算指令，可對三個浮點變數 `ev1`, `ev2`, `ev3` 進行運算。
    * **支援運算**: `=` (賦值), `+` (加), `-` (減), `*` (乘), `/` (除), `%` (取餘)。
    * **支援小數與負數**運算。
    * **角色獨立存檔**:
        * `assign save`: 將當前角色的 `ev1, ev2, ev3` 變數保存到 **`ev_vars.txt`** 中。
        * `assign load`: 從 **`ev_vars.txt`** 中讀取當前角色的變數。
        * 系統會自動根據「帳號」和「角色名稱」在同一個檔案中區分不同角色的資料，不會互相覆蓋。

    * **使用範例**:
        ```
        assign ev1,=,100.5
        assign ev2,+,-50
        assign ev3,*,2
        assign save
        assign load
        ```

### III. 自動化與遊戲修正

* **自動猜謎**: 攔截遊戲內的猜謎視窗，自動從內建資料庫 (`RiddleDatabase.cpp`) 比對問題並填入正確答案或選項。
* **自動堆疊**: 可在設定中啟用，在特定條件下自動執行 `/pile` 指令。
* **坐騎鎖定修復**: 修正了原版程式中，特定坐騎會導致無法使用物品的問題。
* **寵物能力檢查**:
    * `#滿血`: 讀取寵物當前血量上限。
    * `#尾數`: 檢查寵物 HP、攻擊、防禦、敏捷的個位數是否均為 7。
    * `#四圍`: 根據給定的16位字串，判斷寵物 LV 是否相符，且 HP、攻、防、敏是否均達標。

## 3. 關鍵技術原理

* **DLL 進入點 (`dllmain.cpp`)**: 程式的起點。在此處初始化 MinHook 函式庫，並建立一個獨立的 UI 執行緒以避免阻塞目標程式，最後呼叫 `InstallAllHooks()` 安裝所有功能掛鉤。

* **動態位址與全域管理 (`Globals.h`, `helpers.cpp`)**:
    * 程式啟動時，在 `dllmain.cpp` 中使用 `GetModuleHandle(NULL)` 獲取主程式的動態基底位址，並儲存於全域變數 `g_assaInfo.base` 中。
    * 專案中所有需要讀寫記憶體的地方 (如 `helpers.cpp`, `Hooks.cpp`) 均使用這個全域基底位址配合固定的**偏移量 (Offset)** 來計算目標位址，徹底解決了因 ASLR 或作業系統不同導致的位址變動問題。

* **Hook 核心 (`Hooks.cpp`)**:
    * **JMP Hook**: 專案主要採用手動寫入 `JMP` 指令的方式，將程式執行流程重導向至我們自訂的函式。
    * **Naked Function (`__declspec(naked)`)**: 所有 Hook 函式均使用此宣告，讓我們可以完全手動控制組合語言，精確地保存和恢復暫存器，並安全地呼叫 C++ 函式。
    * **組合語言與 C++協作**: 遵循「組合語言做跳板，C++做邏輯」的原則。組合語言負責從暫存器或堆疊中獲取動態參數（如字串指標），然後將其作為參數傳遞給 C++ 函式 (`Process...` 系列函式)，所有複雜的字串解析、檔案讀寫、數學運算都在易於維護的 C++ 中完成。

* **UI 子類化 (`UIManager.cpp`)**: 使用 `SetWindowLongPtrW` 替換視窗的訊息處理程序 (WndProc)，讓我們可以直接攔截並處理所有自訂按鈕的點擊事件，這是實現穩定 UI 互動的關鍵。

* **角色獨立存檔**: `save`/`load` 指令會先讀取遊戲記憶體中的帳號和角色名，組合成唯一的鍵 (如 `MyAccount_MyChar`)。儲存時，會以「先讀取、再覆蓋」的方式更新 `ev_vars.txt`，確保檔案中其他角色的資料不遺失。讀取時，則會根據鍵名在檔案中查找對應的 `[Section]` 來載入資料。

## 4. 如何建置

* **開發環境**: Visual Studio 2022 (或相容版本)
* **目標平台**: x86 (Win32)
* **相依性**: 無外部相依性，專案已內建 MinHook 函式庫的原始碼。
* **步驟**:
    1.  使用 Visual Studio 開啟解決方案檔案 (`.sln`)。
    2.  在上方工具列中，選擇 **Release** 設定。
    3.  在平台下拉選單中，選擇 **x86**。
    4.  點擊功能表中的「建置」->「建置解決方案」。
    5.  編譯成功後，即可在專案的 `Release` 資料夾中找到最終的 `hook.dll` 檔案。